<template name="offermodal">
  <div class="modal fade" id="offerModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg">
      <div class="modal-content modal-order">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
            aria-hidden="true">&times;</span></button>
          {{#if equals offer.type 'bid'}}
            <h4 class="modal-title">BUY OFFER</h4>
          {{else}}
            <h4 class="modal-title">SELL OFFER</h4>
          {{/if}}
        </div>
        <div class="modal-body">
          {{#if offer}}
            <table>
              <tbody>
              <tr class="row-data-line">
                <th>ALLOWANCE</th>
                {{#if equals offer.type 'bid'}}
                  <td>{{{formatBalance baseToken.allowance '' '' true}}} <span
                    class="allowance-currency">{{baseToken._id}}</span></td>
                {{else}}
                  <td>{{{formatBalance quoteToken.allowance '' '' true}}} <span
                    class="allowance-currency">{{quoteToken._id}}</span></td>
                {{/if}}
              </tr>
              <tr class="row-data-line">
                <th>AVAILABLE</th>
                {{#if equals offer.type 'bid'}}
                  <td>{{{formatBalance baseToken.balance '' '' true}}} <span
                    class="allowance-currency">{{baseToken._id}}</span></td>
                {{else}}
                  <td>{{{formatBalance quoteToken.balance '' '' true}}} <span
                    class="allowance-currency">{{quoteToken._id}}</span></td>
                {{/if}}
              </tr>
              <tr class="row-data-line owner">
                <th class="th-owner">OWNER</th>
                <td class="td-owner"><span class="span-owner">{{offer.owner}} {{#if equals offer.owner address}}
                  (<span class="text-success">you</span>){{/if}}</span></td>
              </tr>
              </tbody>
            </table>
            <section class="input-section">
              <div class="available">
                <span class="available-label">PRICE</span>
                <span class="available-amount">{{{formatNumber offer.price '' true}}}</span>
                <span class="available-currency">{{quoteCurrency}}</span>
              </div>
              <table class="bordered">
                <tbody>
                <tr class="row-input-line">
                  <th class="dex-label-cell">
                    <span>VOLUME</span>
                  </th>
                  <td class="dex-input-cell">
                    <input type="number" class="input" step="any" min="0" max={{maxVolume}}
                      {{b "value: volume, input: calcTotal"}}>
                  </td>
                  <td class="dex-currency-cell">
                    <span>{{baseCurrency}}</span>
                  </td>
                </tr>
                <tr class="row-input-line">
                  <th class="dex-label-cell">
                    <span>TOTAL</span>
                  </th>
                  <td class="dex-input-cell">
                    <input type="number" class="input" step="any" min="0" max={{maxTotal}}
                      {{b "value: total, input: calcVolume"}}>
                  </td>
                  <td class="dex-currency-cell">
                    <span>{{quoteCurrency}}</span>
                  </td>
                </tr>
                {{#if offer.helper}}
                  <tr>
                    <td colspan="2">{{offer.helper}}</td>
                  </tr>
                {{/if}}
                </tbody>
              </table>
            </section>
            <section>
              <div class="div-modal-text">
                <div class="row">
                  <div class="col-xs-12">
                    {{#unless isMarketOpen}}
                      <span class="text-danger">
                        The market has closed.
                      </span>
                    {{/unless}}
                    {{#unless validAmount}}
                      <span class="text-danger">
                        Amount is invalid because {{baseCurrency}} has no decimals.
                      </span>
                    {{/unless}}
                    {{#unless hasVolume}}
                      <span class="text-danger">
                        The order doesn't have a high enough {{buyCurrency}} volume.
                      </span>
                    {{else}}
                      {{#unless hasBalance}}
                        <span class="text-danger">
                          You don't have enough
                          {{#if equals sellCurrency 'W-ETH'}}
                            <a href="#ethtokens" {{b  "click: dismiss"}}>{{sellCurrency}}</a>
                          {{else}}
                            {{sellCurrency}}
                          {{/if}} tokens.
                        </span>
                      {{else}}
                        {{#unless hasAllowance}}
                          <span class="text-danger">
                            You are trying to complete a {{offerType}}
                            order above your <strong>defined allowance</strong>.
                          </span>
                        {{else}}
                          <div class="row-fluid">
                            <div class="col-xs-12">
                              <div class="row info-section bordered">
                                <div class="col-xs-7">
                                  {{#if equals offer.type 'bid'}}
                                    <div class="row">
                                      <div class="col-xs-6 dex-currency-label">
                                        <i class="dex-icon-add"></i>
                                        {{{formatBalance (toWei total) '' '' true}}} {{quoteCurrency}}
                                        {{formatPrice (toWei total) quoteCurrency}}
                                      </div>
                                      <div class="col-xs-6 dex-currency-label dex-currency-label--fiat">
                                        <span>~ {{{ formatBalance (toWei (multiply total priceInUSD)) 2 '' true}}}
                                          USD</span>
                                      </div>
                                    </div>
                                    <div class="row">
                                      <div class="col-xs-6 dex-currency-label">
                                        <i class="dex-icon-subtract"></i>
                                        {{{formatBalance (toWei volume) '' '' true}}} {{baseCurrency}}
                                      </div>
                                      <div class="col-xs-6 dex-currency-label dex-currency-label--fiat">
                                        <span>~ {{{ formatBalance (toWei (multiply volume priceInUSD)) 2 '' true}}}
                                          USD</span>
                                      </div>
                                    </div>
                                  {{else}}
                                    <div class="row">
                                      <div class="col-xs-6 dex-currency-label">
                                        <i class="dex-icon-add"></i>
                                        {{{formatBalance (toWei volume) '' '' true}}} {{baseCurrency}}
                                        {{formatPrice (toWei volume) baseCurrency}}
                                      </div>
                                      <div class="col-xs-6 dex-currency-label dex-currency-label--fiat">
                                        <span>~ {{{ formatBalance (toWei (multiply volume priceInUSD)) 2 '' true}}}
                                          USD</span>
                                      </div>
                                    </div>
                                    <div class="row">
                                      <div class="col-xs-6 dex-currency-label">
                                        <i class="dex-icon-subtract"></i>
                                        {{{formatBalance (toWei total) '' '' true}}} {{quoteCurrency}}
                                      </div>
                                      <div class="col-xs-6 dex-currency-label dex-currency-label--fiat">
                                        <span>~ {{{ formatBalance (toWei (multiply total priceInUSD)) 2 '' true}}}
                                          USD</span>
                                      </div>
                                    </div>
                                  {{/if}}
                                </div>
                                <div class="col-xs-5">
                                  <div class="row">
                                    <div class="col-xs-7 dex-order-matching-label" style="padding-right:0">
                                      <span> Order Matching </span>
                                    </div>
                                    <div class="col-xs-5" style="padding-left:0">
                                        <span class="dex-order-matching-status
                                                     dex-order-matching-status--{{ternary isMatchingEnabled "active"
                                                                                          "inactive"}}">
                                          {{ternary isMatchingEnabled "ACTIVE" "INACTIVE"}}
                                        </span>
                                    </div>
                                  </div>
                                </div>
                              </div>
                              <div class="row">
                                <div class="col-xs-1">
                                  <img src="order-warning.svg" class="order-warning">
                                </div>
                                <div class="col-xs-11">
                                   <span class="text-clarifications">
                                  If someone (partially) fills this order before you do, your offer may only be
                                  partially filled or even denied, in which case unused funds will be refunded to your
                                  balance and allowance.
                                   </span>
                                </div>
                              </div>
                            </div>
                          </div>
                        {{/unless}}
                      {{/unless}}
                    {{/unless}}
                  </div>
                </div>
              </div>
              {{#if and alertBetterOffer isBuyEnabled}}
                <div class="div-modal-text highlighted">
                  <div class="row-fluid">
                    <div class="col-xs-1">
                      <img style="opacity: 0.5" src="order-warning-red.svg" fill="red" class="order-warning">
                    </div>
                    <div class="col-xs-11">
                  <span class="text-danger">
                    WARNING: You have not chosen the best price available. Review the order book to find a better trade.
                  </span>
                    </div>
                  </div>
                </div>
              {{/if}}
            </section>
          {{/if}}
        </div>
        <div class="modal-footer">
          {{#if or (and hasBalance hasAllowance) (not hasBalance)}}
            {{#if offer}}
              <button type="button"
                      class="btn dex-btn-default {{#if equals offer.type
                                                       'bid'}}sell{{else}}buy{{/if}} btn-placement-right"
                      data-dismiss="modal" {{b "enable: canBuy, click: buy"}}>
                {{#if equals offer.type 'bid'}}SELL{{else}}BUY{{/if}} {{baseCurrency}}
              </button>
            {{/if}}
          {{else}}
            {{#if equals offer.type 'bid'}}
              <button type="button" data-refer="existingOrder" data-link="{{baseCurrency}}" data-dismiss="modal"
                      class="btn btn-allowance-modal btn-default btn-submit-order-allowance btn-placement-right">
                Change Allowance
              </button>
            {{else}}
              <button type="button" data-refer="existingOrder" data-link="{{quoteCurrency}}" data-dismiss="modal"
                      class="btn btn-allowance-modal btn-default btn-submit-order-allowance {{offerType}} btn-placement-right">
                Change Allowance
              </button>
            {{/if}}
          {{/if}}
          <button type="button" class="btn btn-default btn-placement-left btn-submit-order-cancel" data-dismiss="modal">
            CANCEL
          </button>
        </div>
      </div>
    </div>
  </div>

  {{#if quoteToken}}
    {{> newallowance token=quoteToken}}
  {{/if}}
  {{#if baseToken}}
    {{> newallowance token=baseToken}}
  {{/if}}

  <div class="modal fade" id="newOrderModal" tabindex="-1" role="dialog" data-backdrop="false">
    <div class="modal-dialog">
      <div class="modal-content modal-order">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
            aria-hidden="true">&times;</span></button>
          <h4 class="modal-title">{{offerType}} OFFER</h4>
        </div>
        <div class="modal-body">
          <table>
            <tbody>
            <tr class="row-data-line">
              <th>ALLOWANCE</th>
              {{#if equals offerType 'buy'}}
                <td>{{{formatBalance quoteToken.allowance '' '' true}}} <span
                  class="allowance-currency">{{quoteToken._id}}</span></td>
              {{else}}
                <td>{{{formatBalance baseToken.allowance '' '' true}}} <span
                  class="allowance-currency">{{baseToken._id}}</span></td>
              {{/if}}
            </tr>
            <tr class="row-data-line">
              <th>AVAILABLE</th>
              {{#if equals offerType 'buy'}}
                <td>{{{formatBalance quoteToken.balance '' '' true}}} <span
                  class="allowance-currency">{{quoteToken._id}}</span></td>
              {{else}}
                <td>{{{formatBalance baseToken.balance '' '' true}}} <span
                  class="allowance-currency">{{baseToken._id}}</span></td>
              {{/if}}
            </tr>
            <!--TODO: wrap this based on the market type. Display only if sniping is enabled-->
            <tr class="row-data-line owner">
              <th>OWNER</th>
              <td><span class="owner-address">{{address}}</span></td>
            </tr>
            </tbody>
          </table>
          <section class="input-section">
            <table class="bordered">
              <tbody>
              <tr class="row-input-line">
                <th class="dex-label-cell">
                  <span>PRICE</span>
                </th>
                <td class="dex-input-cell">
                  <input type="number" class="input" step="any" min="0"
                    {{b "value: offerPrice, input: calcNewOfferTotal"}}>
                </td>
                <td class="dex-currency-cell">
                  <span>{{quoteCurrency}}</span>
                </td>
              </tr>
              <tr class="row-input-line">
                <th class="dex-label-cell">
                  <span>VOLUME</span>
                </th>
                <td class="dex-input-cell">
                  <input type="number" class="input" step="any" min="0" max={{maxNewOfferAmount}}
                    {{b "value: offerAmount, input: calcNewOfferTotal"}}>
                </td>
                <td class="dex-currency-cell">
                  <span>{{baseCurrency}}</span>
                </td>
              </tr>
              <tr class="row-input-line">
                <th class="dex-label-cell">
                  <span>TOTAL</span>
                </th>
                <td class="dex-input-cell">
                  <input type="number" class="input" step="any" min="0" max={{maxNewOfferTotal}}
                    {{b "value: offerTotal, input: calcNewOfferAmount"}}>
                </td>
                <td class="dex-currency-cell">
                  <span>{{quoteCurrency}}</span>
                </td>
              </tr>
              </tbody>
            </table>
          </section>
          <section>
            <div class="div-modal-text">
              <div class="row">
                <div class="col-xs-12">
                  <span class="text-clarifications">
                    {{#unless validNewOrderAmount}}
                      Amount is invalid because {{baseCurrency}} has no decimals.
                    {{else}}
                      {{#unless aboveLimit}}
                        You are trying to create a {{offerType}} order below the minimum <strong>market limit</strong>,
                        {{#if equals offerType 'buy'}}
                          which is {{{formatBalance limit '' '' true}}} {{quoteCurrency}}.
                        {{else}}
                          which is {{{formatBalance limit '' '' true}}} {{baseCurrency}}.
                        {{/if}}
                      {{else}}
                        {{#unless hasAllowanceNewOrder offerType}}
                          You are trying to create a {{offerType}} order above your <strong>defined allowance</strong>.
                        {{else}}
                          <div class="row-fluid">
                            <div class="col-xs-12">
                              <div class="row info-section bordered
                                   {{ternary gasEstimateMoreThanGasLimit 'bordered--danger' ''}}">
                                {{#if (not gasEstimateMoreThanGasLimit) }}
                                  <div class="col-xs-7">
                                    {{#if equals offerType 'buy'}}
                                      <div class="row">
                                      <div class="col-xs-6 dex-currency-label">
                                        <i class="dex-icon-add"></i>
                                        {{{formatBalance (toWei offerAmount) '' '' true}}} {{baseCurrency}}
                                        {{formatPrice (toWei offerAmount) baseCurrency}}
                                      </div>
                                      <div class="col-xs-6 dex-currency-label dex-currency-label--fiat">
                                        <span>~ {{{ formatBalance (toWei (multiply offerAmount priceInUSD)) 2 '' true}}}
                                          USD</span>
                                      </div>
                                    </div>
                                    <div class="row">
                                      <div class="col-xs-6 dex-currency-label">
                                        <i class="dex-icon-subtract"></i>
                                        {{{formatBalance (toWei offerTotal) '' '' true}}} {{quoteCurrency}}
                                      </div>
                                      <div class="col-xs-6 dex-currency-label dex-currency-label--fiat">
                                        <span>~ {{{ formatBalance (toWei (multiply offerTotal priceInUSD)) 2 '' true}}}
                                          USD</span>
                                      </div>
                                    </div>
                                    {{else}}
                                      <div class="row">
                                      <div class="col-xs-6 dex-currency-label">
                                        <i class="dex-icon-add"></i>
                                        {{{formatBalance (toWei offerTotal) '' '' true}}} {{quoteCurrency}}
                                        {{formatPrice (toWei offerTotal) quoteCurrency}}
                                      </div>
                                      <div class="col-xs-6 dex-currency-label dex-currency-label--fiat">
                                        <span>~ {{{ formatBalance (toWei (multiply offerTotal priceInUSD)) 2 '' true}}}
                                          USD</span>
                                      </div>
                                    </div>
                                    <div class="row">
                                      <div class="col-xs-6 dex-currency-label">
                                        <i class="dex-icon-subtract"></i>
                                        {{{formatBalance (toWei offerAmount) '' '' true}}} {{baseCurrency}}
                                      </div>
                                      <div class="col-xs-6 dex-currency-label dex-currency-label--fiat">
                                        <span>~ {{{ formatBalance (toWei (multiply offerAmount priceInUSD)) 2 '' true}}}
                                          USD</span>
                                      </div>
                                    </div>
                                    {{/if}}
                                  </div>
                                  <div class="col-xs-5">
                                  <div class="row">
                                    <div class="col-xs-7 dex-order-matching-label" style="padding-right:0">
                                      <span> Order Matching </span>
                                    </div>
                                    <div class="col-xs-5" style="padding-left:0">
                                      <span class="dex-order-matching-status
                                        dex-order-matching-status--{{ternary isMatchingEnabled "active" "inactive"}}">
                                        {{ternary isMatchingEnabled "ACTIVE" "INACTIVE"}}
                                      </span>
                                    </div>
                                  </div>
                                  <div class="row">
                                    <div class="col-xs-12">
                                      {{#if or (gasEstimateInProgress) (or gasEstimateResult gasEstimateError)}}
                                        {{#if gasEstimateInProgress}}
                                          Estimating gas... <span class="loading-icon">{{{loadingIcon}}}</span>
                                        {{else}}
                                          {{#if gasEstimateResult}}
                                            {{estimateGasInETH}}
                                            <span class="dex-currency-label">Gas {{{formatNumber gasEstimateInETH 4
                                                                                                 true}}} ETH</span>
                                            <span class="dex-currency-label dex-currency-label--fiat">
                                              <span>~ {{{ formatNumber (multiply gasEstimateInETH priceInUSD) 2 true}}}
                                                USD</span>
                                            </span>
                                          {{else}}
                                            {{#if gasEstimateError}}
                                              Gas estimation failed.
                                            {{/if}}
                                          {{/if}}
                                        {{/if}}
                                      {{/if}}
                                    </div>
                                  </div>
                                </div>
                                {{else}}
                                  <div class="div-modal-text highlighted">
                                    <div class="row-fluid">
                                      <div class="col-xs-1">
                                        <img style="opacity: 0.5" src="order-warning-red.svg" fill="red"
                                             class="order-warning">
                                      </div>
                                      <div class="col-xs-11">
                                        <span class="text-danger">
                                           Your {{offerType}} exceeds the gas limit of <strong>{{formatGasLimit gasLimit 1000000 'M'}}</strong>.
                                           <br>
                                           To get a working order use the
                                           <strong>{{ternary (equals offerType 'buy') 'Buy' 'Sell'}} Max Button</strong> .
                                        </span>
                                      </div>
                                    </div>
                                  </div>
                                {{/if}}
                              </div>
                            </div>
                          </div>
                        {{/unless}}
                      {{/unless}}
                    {{/unless}}
                  </span>
                </div>
              </div>
            </div>
          </section>
        </div>
        <div class="modal-footer">
          {{#unless hasAllowanceNewOrder offerType}}
            {{#if equals offerType 'buy'}}
              <button type="button" data-refer="newOrder" data-link={{quoteCurrency}} class="btn btn-allowance-modal
                      btn-default btn-submit-order-allowance btn-placement-right
              " data-dismiss="modal">Change Allowance</button>
            {{else}}
              <button type="button" data-refer="newOrder" data-link={{baseCurrency}} class="btn btn-allowance-modal
                      btn-default btn-submit-order-allowance btn-placement-right
              " data-dismiss="modal">Change Allowance</button>
            {{/if}}
          {{else}}
            <button type="button" class="btn dex-btn-default {{offerType}} btn-placement-right" data-dismiss="modal" {{b
              "enable: canSubmit, click: confirmOffer"}}>{{offerType}} {{baseCurrency}}</button>
          {{/unless}}
          <button type="button" class="btn btn-default btn-placement-left btn-submit-order-cancel" data-dismiss="modal">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>
</template>
